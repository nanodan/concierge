<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1F1A16">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Concierge">
  <title>Concierge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/css/file-panel.css">
  <!-- Theme loaded AFTER base styles so theme overrides work -->
  <link id="color-theme-link" rel="stylesheet" href="/css/themes/darjeeling.css">
  <script>
    // Apply saved color theme immediately to prevent flash
    (function() {
      var saved = localStorage.getItem('colorTheme');
      if (saved && saved !== 'darjeeling') {
        document.getElementById('color-theme-link').href = '/css/themes/' + saved + '.css';
      }
    })();
  </script>
</head>
<body>
  <div class="views-container">
  <!-- Conversation List View -->
  <div id="list-view" class="view">
    <header class="top-bar list-header">
      <div class="brand">
        <svg class="brand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <ellipse cx="12" cy="18" rx="10" ry="3" stroke-width="1.5"/>
          <path d="M12 6V4M12 6C7.5 6 4 10 4 15h16c0-5-3.5-9-8-9z" stroke-width="1.5" stroke-linecap="round"/>
          <circle cx="12" cy="4" r="1.5" fill="currentColor" stroke="none"/>
        </svg>
        <h1>Concierge</h1>
      </div>
      <div class="header-actions">
        <button id="collapse-all-btn" class="header-icon-btn" aria-label="Collapse all" title="Collapse all">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M7 8l5 5 5-5"/><path d="M7 16l5-5 5 5"/></svg>
        </button>
        <button id="select-mode-btn" class="header-icon-btn" aria-label="Select conversations">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12l2 2 4-4"/></svg>
        </button>
        <button id="general-files-btn" class="header-icon-btn" aria-label="Files, Git & History">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
        </button>
        <button id="stats-btn" class="header-icon-btn" aria-label="Stats">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="12" width="4" height="9"/><rect x="10" y="7" width="4" height="14"/><rect x="17" y="2" width="4" height="19"/></svg>
        </button>
        <button id="archive-toggle" class="header-icon-btn" aria-label="Show archived">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="5" rx="1"/><path d="M4 9v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9"/><path d="M10 13h4"/></svg>
        </button>
        <button id="more-menu-btn" class="header-icon-btn" aria-label="More options">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
        </button>
      </div>
    </header>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Search conversations..." autocomplete="off">
      <button type="button" id="semantic-toggle" class="semantic-toggle-btn" aria-label="Toggle semantic search" title="Semantic search">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg>
      </button>
      <button type="button" id="filter-toggle" class="filter-toggle-btn" aria-label="Toggle filters">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
      </button>
    </div>
    <div id="filter-row" class="filter-row hidden">
      <button class="filter-chip" data-days="7">7 days</button>
      <button class="filter-chip" data-days="30">30 days</button>
      <select id="filter-model" class="filter-model-select">
        <option value="">All models</option>
      </select>
    </div>
    <div id="pull-indicator" class="pull-indicator">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 15 12 9 18 15"/></svg>
    </div>
    <div id="conversation-list" class="conversation-list"></div>
    <button id="new-chat-btn" class="fab" aria-label="New conversation"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
    <!-- Bulk action bar -->
    <div id="bulk-action-bar" class="bulk-action-bar hidden">
      <div class="bulk-action-left">
        <button id="bulk-cancel-btn" class="bulk-cancel-btn">Cancel</button>
        <span id="bulk-count" class="bulk-count">0 selected</span>
      </div>
      <div class="bulk-action-right">
        <button id="bulk-select-all-btn" class="bulk-action-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12l2 2 4-4"/></svg>
          All
        </button>
        <button id="bulk-archive-btn" class="bulk-action-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="5" rx="1"/><path d="M4 9v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9"/><path d="M10 13h4"/></svg>
          Archive
        </button>
        <button id="bulk-delete-btn" class="bulk-action-btn danger">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Long-press action popup -->
  <div id="action-popup" class="action-popup hidden">
    <button class="action-popup-btn" data-action="pin" id="popup-pin-btn">Pin</button>
    <button class="action-popup-btn" data-action="archive" id="popup-archive-btn">Archive</button>
    <button class="action-popup-btn" data-action="rename">Rename</button>
    <button class="action-popup-btn" data-action="branches">View branches</button>
    <button class="action-popup-btn danger" data-action="delete">Delete</button>
  </div>
  <div id="action-popup-overlay" class="action-popup-overlay hidden"></div>

  <!-- Message action popup (edit/copy on messages) -->
  <div id="msg-action-popup" class="action-popup hidden"></div>

  <!-- Chat View -->
  <div id="chat-view" class="view">
    <header class="top-bar chat-header">
      <button id="back-btn" class="back-btn" aria-label="Back">&larr;</button>
      <div class="chat-title">
        <span id="chat-name"></span>
        <span id="chat-cwd-indicator" class="chat-cwd-indicator hidden"></span>
        <span id="chat-status" class="status-dot"></span>
        <span id="mode-badge" class="mode-badge">AP</span>
        <div id="model-selector" class="model-selector">
          <button id="model-btn" class="model-badge-btn">Sonnet 4.5</button>
          <div id="model-dropdown" class="model-dropdown hidden"></div>
        </div>
        <div id="conv-stats-selector" class="conv-stats-selector hide-mobile">
          <button id="conv-stats-btn" class="conv-stats-btn" aria-label="Conversation stats" title="Stats">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
          </button>
        </div>
        <button id="branches-btn" class="branches-btn hide-mobile" aria-label="View branches" title="View branches">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="6" cy="6" r="3"/><circle cx="18" cy="18" r="3"/><circle cx="18" cy="6" r="3"/><path d="M6 9v6c0 3 3 3 6 3h3"/></svg>
        </button>
        <button id="capabilities-btn" class="capabilities-btn hide-mobile" aria-label="View commands" title="Commands &amp; Skills">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 17l6-6-6-6"/><path d="M12 19h8"/></svg>
        </button>
        <button id="memory-btn" class="memory-indicator active hide-mobile" aria-label="Toggle memory" title="Memory">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
          </svg>
        </button>
      </div>
      <button id="new-chat-here-btn" class="header-icon-btn hide-mobile" aria-label="New chat in this folder" title="New chat in this folder">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button id="files-btn" class="files-btn hide-mobile" aria-label="Files, Git & History">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
      </button>
      <button id="export-btn" class="export-btn hide-mobile" aria-label="Export conversation">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      </button>
      <button id="delete-btn" class="delete-btn hide-mobile" aria-label="Delete conversation">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      <button id="chat-more-btn" class="header-icon-btn" aria-label="More options">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
      </button>
    </header>
    <div id="context-bar" class="context-bar hidden" role="button" tabindex="0" aria-expanded="false">
      <div class="context-bar-track"><div id="context-bar-fill" class="context-bar-fill"></div></div>
      <span id="context-bar-label" class="context-bar-label">0k / 200k</span>
      <svg class="context-bar-expand" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
    <div id="context-breakdown" class="context-breakdown hidden"></div>
    <div id="reconnect-banner" class="reconnect-banner hidden">
      <span id="reconnect-text">Reconnecting...</span>
      <button id="reconnect-retry-btn" class="reconnect-retry-btn">Retry Now</button>
    </div>
    <div id="unsafe-banner" class="unsafe-banner hidden">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      <span>Sandbox disabled â€” Claude has unrestricted file access</span>
    </div>
    <div id="chat-empty-state" class="chat-empty-state hidden">
      <div class="chat-empty-icon">
        <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="18" rx="10" ry="3"/><path d="M12 6V4M12 6C7.5 6 4 10 4 15h16c0-5-3.5-9-8-9z"/><circle cx="12" cy="4" r="1.5" fill="currentColor" stroke="none"/></svg>
      </div>
      <p>How may I assist you?</p>
      <span>Your concierge is ready</span>
    </div>
    <div id="messages" class="messages">
      <button id="load-more-btn" class="load-more-btn hidden">Load earlier messages</button>
    </div>
    <button id="jump-to-bottom" class="scroll-pill" aria-label="Jump to bottom">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
    </button>
    <div id="typing-indicator" class="typing-indicator hidden">
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
      <span class="typing-timer"></span>
    </div>
    <div id="attachment-preview" class="attachment-preview hidden"></div>
    <form id="input-form" class="input-bar">
      <button type="button" id="attach-btn" class="attach-btn" aria-label="Attach file">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
        </svg>
      </button>
      <input type="file" id="file-input" multiple accept="image/*,.txt,.md,.js,.ts,.py,.json,.csv,.xml,.html,.css,.pdf" hidden>
      <button type="button" id="mic-btn" class="mic-btn" aria-label="Voice input">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
          <line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
      </button>
      <textarea id="message-input" placeholder="Message Claude..." rows="1" autocomplete="off"></textarea>
      <button type="submit" id="send-btn" aria-label="Send"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg></button>
      <button type="button" id="cancel-btn" class="cancel-btn hidden" aria-label="Cancel"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg></button>
    </form>
    <div id="chat-drop-overlay" class="chat-drop-overlay"></div>
    <!-- File Panel (Project Mode) -->
    <div id="file-panel-backdrop" class="file-panel-backdrop"></div>
    <div id="file-panel" class="file-panel hidden">
      <div class="file-panel-header">
        <div class="file-panel-drag-handle"></div>
        <div id="file-panel-tabs" class="file-panel-tabs">
          <button id="files-tab" class="file-panel-tab active" data-tab="files">Files</button>
          <button id="changes-tab" class="file-panel-tab" data-tab="changes">Changes</button>
          <button id="history-tab" class="file-panel-tab" data-tab="history">History</button>
          <button id="data-tab" class="file-panel-tab" data-tab="data">Data</button>
          <button id="preview-tab" class="file-panel-tab" data-tab="preview">Preview</button>
        </div>
        <button id="file-panel-fullscreen" class="file-panel-fullscreen" aria-label="Toggle fullscreen" title="Toggle fullscreen">
          <svg class="expand-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
          <svg class="collapse-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14h6v6"/><path d="M20 10h-6V4"/><path d="M14 10l7-7"/><path d="M3 21l7-7"/></svg>
        </button>
        <button id="file-panel-close" class="file-panel-close" aria-label="Close">&times;</button>
      </div>
      <!-- Files View -->
      <div id="files-view" class="files-view">
        <div class="file-panel-nav">
          <button id="file-panel-up" class="file-panel-up" disabled aria-label="Parent directory">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
          </button>
          <svg class="file-panel-path-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          <span id="file-panel-path" class="file-panel-path">.</span>
          <input type="text" id="file-search-input" class="file-search-input" placeholder="Search files..." autocomplete="off">
          <button id="file-panel-refresh-btn" class="file-panel-refresh-btn" aria-label="Refresh">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          </button>
          <button id="file-panel-upload-btn" class="file-panel-upload-btn" aria-label="Upload file">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          </button>
          <input type="file" id="file-panel-file-input" multiple hidden>
        </div>
        <div id="file-tree" class="file-tree"></div>
      </div>
      <!-- Changes View (Git) -->
      <div id="changes-view" class="changes-view hidden">
        <div class="file-panel-nav changes-nav">
          <button id="branch-selector" class="branch-selector hidden">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3v12"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>
            <span class="branch-name">main</span>
            <span id="ahead-behind-badge" class="ahead-behind-badge hidden"></span>
            <svg class="branch-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div id="branch-dropdown" class="branch-dropdown hidden"></div>
          <button id="stash-btn" class="git-action-btn" aria-label="Stash" title="Stash changes" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6"/><path d="M9 15h6"/></svg>
          </button>
          <button id="pull-btn" class="git-action-btn" aria-label="Pull" title="Pull from remote" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/></svg>
          </button>
          <button id="push-btn" class="git-action-btn" aria-label="Push" title="Push to remote" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>
          </button>
          <button id="git-refresh-btn" class="git-refresh-btn" aria-label="Refresh" title="Refresh">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          </button>
        </div>
        <div id="changes-list" class="changes-list"></div>
        <div id="commit-form" class="commit-form hidden">
          <textarea id="commit-message" class="commit-message" placeholder="Commit message..." rows="2"></textarea>
          <button id="commit-btn" class="commit-btn">Commit</button>
        </div>
      </div>
      <!-- History View (Git Commits) -->
      <div id="history-view" class="history-view hidden">
        <div id="history-list" class="history-list"></div>
      </div>
      <!-- Data View (DuckDB + BigQuery SQL Analysis) -->
      <div id="data-view" class="data-view hidden">
        <div class="data-tab-source-row">
          <label class="data-tab-source-label" for="data-source-select">Source</label>
          <select id="data-source-select" class="data-tab-source-select">
            <option value="duckdb">DuckDB</option>
            <option value="bigquery">BigQuery</option>
          </select>
          <div id="bigquery-controls" class="data-tab-bq-controls hidden">
            <span id="bigquery-auth-status" class="data-tab-bq-status">Not connected</span>
            <button id="bigquery-connect-btn" class="data-tab-bq-connect-btn" title="Re-check ADC credentials">Recheck</button>
            <select id="bigquery-project-select" class="data-tab-bq-project-select" disabled>
              <option value="">ADC unavailable</option>
            </select>
          </div>
        </div>
        <div id="data-tables-row" class="data-tab-tables-row">
          <div id="tables-container" class="data-tab-tables">
            <span class="data-tab-no-tables">No tables loaded</span>
          </div>
          <button id="load-table-btn" class="data-tab-load-btn" title="Browse files to load">+ Browse</button>
        </div>
        <div class="data-tab-editor">
          <textarea id="sql-editor" class="data-tab-sql-editor" placeholder="SELECT * FROM table LIMIT 100" spellcheck="false"></textarea>
          <div class="data-tab-controls">
            <button id="run-query-btn" class="data-tab-run-btn">Run</button>
            <button id="cancel-query-btn" class="data-tab-cancel-btn hidden">Cancel</button>
            <button id="query-history-btn" class="data-tab-history-btn" title="Query history">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </button>
            <div id="query-history-dropdown" class="data-tab-history-dropdown hidden"></div>
            <span id="query-status" class="data-tab-status"></span>
          </div>
        </div>
        <div id="results-container" class="data-tab-results"></div>
      </div>
      <!-- Preview View (Live Preview) -->
      <div id="preview-view" class="preview-view hidden">
        <div class="preview-empty" id="preview-empty">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
            <line x1="8" y1="21" x2="16" y2="21"/>
            <line x1="12" y1="17" x2="12" y2="21"/>
          </svg>
          <p id="preview-message">Not running</p>
          <button id="preview-start-btn" class="preview-start-btn">Start Preview</button>
        </div>
        <div class="preview-running hidden" id="preview-running">
          <div class="preview-file-row">
            <select id="preview-file-select" class="preview-file-select">
              <option value="">Select file...</option>
            </select>
          </div>
          <div class="preview-actions" id="preview-actions">
            <button id="preview-inline-btn" class="preview-btn primary">Show Inline</button>
            <a id="preview-open-btn" class="preview-btn" href="#" target="_blank">Open Tab</a>
            <button id="preview-stop-btn" class="preview-btn">Stop</button>
          </div>
          <div id="preview-iframe-wrapper" class="preview-iframe-wrapper hidden">
            <div class="preview-toolbar">
              <div class="preview-toolbar-actions">
                <button id="preview-fit-toggle" class="preview-fit-toggle active" aria-label="Toggle fit mode" title="Fit to width">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>
                </button>
                <button id="preview-refresh-btn" class="preview-refresh-btn" aria-label="Refresh" title="Refresh">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                </button>
                <a id="preview-open-btn-toolbar" class="preview-toolbar-btn" href="#" target="_blank" aria-label="Open in new tab" title="Open in new tab">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                </a>
                <button id="preview-hide-btn" class="preview-toolbar-btn" aria-label="Hide inline preview" title="Hide">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                </button>
              </div>
            </div>
            <div id="preview-iframe-container" class="preview-iframe-container fit-mode">
              <div id="preview-iframe-scaler" class="preview-iframe-scaler">
                <iframe id="preview-iframe" class="preview-iframe" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- File Viewer (shared) -->
      <div id="file-viewer" class="file-viewer hidden">
        <div class="file-viewer-header">
          <span id="file-viewer-name" class="file-viewer-name"></span>
          <div class="file-viewer-actions">
            <button id="diff-granular-toggle" class="diff-granular-toggle hidden" title="Toggle granular view">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
              </svg>
            </button>
            <button id="file-viewer-close" class="file-viewer-close">Back</button>
          </div>
        </div>
        <pre id="file-viewer-content" class="file-viewer-content"><code></code></pre>
      </div>
    </div>
  </div>

  <!-- Stats View -->
  <div id="stats-view" class="view">
    <header class="top-bar chat-header">
      <button id="stats-back-btn" class="back-btn" aria-label="Back">&larr;</button>
      <div class="chat-title"><span>Stats</span></div>
    </header>
    <div id="stats-content" class="stats-content"></div>
  </div>

  <!-- Branches View -->
  <div id="branches-view" class="view">
    <header class="top-bar chat-header">
      <button id="branches-back-btn" class="back-btn" aria-label="Back">&larr;</button>
      <div class="chat-title"><span>Conversation Branches</span></div>
    </header>
    <div id="branches-content" class="branches-content"></div>
  </div>

  <!-- Standalone Files View -->
  <div id="files-standalone-view" class="view">
    <header class="top-bar chat-header">
      <button id="files-standalone-back-btn" class="back-btn" aria-label="Back">&larr;</button>
      <div class="chat-title">
        <span id="files-standalone-title">Files</span>
      </div>
    </header>
    <div class="files-standalone-panel">
      <div class="file-panel-header">
        <div id="sa-file-panel-tabs" class="file-panel-tabs">
          <button class="file-panel-tab active" data-tab="files">Files</button>
          <button class="file-panel-tab" data-tab="changes">Changes</button>
          <button class="file-panel-tab" data-tab="history">History</button>
        </div>
      </div>
      <!-- Files View -->
      <div id="sa-files-view" class="files-view">
        <div class="file-panel-nav">
          <button id="files-standalone-up" class="file-panel-up" disabled aria-label="Parent directory">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
          </button>
          <svg class="file-panel-path-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          <span id="files-standalone-path" class="file-panel-path">.</span>
          <button id="files-standalone-refresh-btn" class="file-panel-refresh-btn" aria-label="Refresh">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          </button>
          <button id="files-standalone-upload-btn" class="file-panel-upload-btn" aria-label="Upload file">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          </button>
          <input type="file" id="files-standalone-file-input" multiple hidden>
        </div>
        <div id="files-standalone-tree" class="file-tree"></div>
      </div>
      <!-- Changes View (Git) -->
      <div id="sa-changes-view" class="changes-view hidden">
        <div class="file-panel-nav changes-nav">
          <button id="sa-branch-selector" class="branch-selector hidden">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3v12"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>
            <span class="branch-name">main</span>
            <span id="sa-ahead-behind-badge" class="ahead-behind-badge hidden"></span>
            <svg class="branch-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div id="sa-branch-dropdown" class="branch-dropdown hidden"></div>
          <button id="sa-stash-btn" class="git-action-btn" aria-label="Stash" title="Stash changes" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6"/><path d="M9 15h6"/></svg>
          </button>
          <button id="sa-pull-btn" class="git-action-btn" aria-label="Pull" title="Pull from remote" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/></svg>
          </button>
          <button id="sa-push-btn" class="git-action-btn" aria-label="Push" title="Push to remote" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>
          </button>
          <button id="sa-git-refresh-btn" class="git-refresh-btn" aria-label="Refresh" title="Refresh">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          </button>
        </div>
        <div id="sa-changes-list" class="changes-list"></div>
        <div id="sa-commit-form" class="commit-form hidden">
          <textarea id="sa-commit-message" class="commit-message" placeholder="Commit message..." rows="2"></textarea>
          <button id="sa-commit-btn" class="commit-btn">Commit</button>
        </div>
      </div>
      <!-- History View (Git Commits) -->
      <div id="sa-history-view" class="history-view hidden">
        <div id="sa-history-list" class="history-list"></div>
      </div>
      <!-- File Viewer (shared) -->
      <div id="files-standalone-viewer" class="file-viewer hidden">
        <div class="file-viewer-header">
          <span id="files-standalone-viewer-name" class="file-viewer-name"></span>
          <div class="file-viewer-actions">
            <button id="sa-diff-granular-toggle" class="diff-granular-toggle hidden" title="Toggle granular view">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
              </svg>
            </button>
            <button id="files-standalone-viewer-close" class="file-viewer-close">Back</button>
          </div>
        </div>
        <pre id="files-standalone-viewer-content" class="file-viewer-content"><code></code></pre>
      </div>
    </div>
  </div>

  <!-- Memory View -->
  <div id="memory-view" class="view">
    <header class="top-bar chat-header">
      <button id="memory-back-btn" class="back-btn" aria-label="Back">&larr;</button>
      <div class="chat-title"><span>Memory</span></div>
    </header>
    <div id="memory-content" class="memory-content"></div>
  </div>

  <div id="toast-container" class="toast-container"></div>
  </div><!-- /views-container -->

  <!-- New Conversation Modal -->
  <div id="modal-overlay" class="modal-overlay hidden">
    <div class="modal">
      <h2>New Conversation</h2>
      <form id="new-conv-form">
        <label for="conv-name">Name</label>
        <input type="text" id="conv-name" placeholder="e.g. Fix auth bug" required>
        <label for="conv-cwd">Working Directory</label>
        <div class="cwd-input-row">
          <input type="text" id="conv-cwd" placeholder="e.g. ~/projects/my-app">
          <button type="button" id="browse-btn" class="btn-icon" aria-label="Browse">&#x1F4C2;</button>
        </div>
        <div id="recent-dirs" class="recent-dirs hidden">
          <span class="recent-dirs-label">Recent:</span>
          <div id="recent-dirs-list" class="recent-dirs-list"></div>
        </div>
        <div id="dir-browser" class="dir-browser hidden">
          <div class="dir-browser-header">
            <button type="button" id="dir-up-btn" class="btn-icon" aria-label="Parent directory">&#x2191;</button>
            <span id="dir-current-path" class="dir-current-path"></span>
          </div>
          <div id="dir-list" class="dir-list"></div>
          <div class="dir-browser-actions">
            <button type="button" id="dir-new-btn" class="btn-secondary btn-sm">New Folder</button>
            <button type="button" id="dir-select-btn" class="btn-primary btn-sm">Select</button>
          </div>
        </div>
        <div class="toggle-row">
          <div class="toggle-label">
            <label for="conv-sandboxed">Sandboxed</label>
            <span class="toggle-hint">Restrict to project folder only</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="conv-sandboxed" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <div class="toggle-label">
            <label for="conv-autopilot">Autopilot</label>
            <span class="toggle-hint">Full access (off = read-only)</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="conv-autopilot" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <label for="conv-provider">Provider</label>
        <select id="conv-provider" class="model-select">
          <option value="claude">Claude</option>
          <option value="codex">OpenAI Codex</option>
          <option value="ollama">Ollama (Local)</option>
        </select>
        <label for="conv-model">Model</label>
        <select id="conv-model" class="model-select">
          <option value="claude-sonnet-4.5">Sonnet 4.5</option>
        </select>
        <div class="modal-actions">
          <button type="button" id="modal-cancel" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Dialog (replaces confirm/prompt/alert) -->
  <div id="dialog-overlay" class="dialog-overlay hidden">
    <div class="dialog">
      <div class="dialog-title" id="dialog-title"></div>
      <div class="dialog-body" id="dialog-body"></div>
      <input type="text" id="dialog-input" class="dialog-input hidden" autocomplete="off">
      <div class="dialog-actions">
        <button id="dialog-cancel" class="btn-secondary">Cancel</button>
        <button id="dialog-ok" class="btn-primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Color theme dropdown (positioned at body level to avoid stacking context issues) -->
  <div id="color-theme-dropdown" class="theme-dropdown hidden">
    <div class="theme-option" data-color-theme="darjeeling">
      <svg class="theme-option-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
      <span>Darjeeling</span>
    </div>
    <div class="theme-option" data-color-theme="budapest">
      <svg class="theme-option-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="10" width="18" height="11" rx="2"/><path d="M9 21v-6a3 3 0 0 1 6 0v6"/><path d="M3 10V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v4"/><path d="M12 2v2"/></svg>
      <span>Budapest</span>
    </div>
    <div class="theme-option" data-color-theme="moonrise">
      <svg class="theme-option-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 11l2-2 4 4 6-6 6 6"/><path d="M3 17l2-2 4 4 6-6 6 6"/></svg>
      <span>Moonrise</span>
    </div>
    <div class="theme-option" data-color-theme="aquatic">
      <svg class="theme-option-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12c2-3 5-5 10-5s8 2 10 5c-2 3-5 5-10 5s-8-2-10-5z"/><circle cx="12" cy="12" r="3"/></svg>
      <span>Aquatic</span>
    </div>
    <div class="theme-option" data-color-theme="fjord">
      <svg class="theme-option-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3l4 8 5-5 4 14H3L8 3z"/></svg>
      <span>Fjord</span>
    </div>
    <div class="theme-option" data-color-theme="monokai">
      <svg class="theme-option-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 8h4"/><path d="M7 12h8"/><path d="M7 16h6"/></svg>
      <span>Monokai</span>
    </div>
    <div class="theme-option" data-color-theme="catppuccin">
      <svg class="theme-option-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 8c-2 0-3.5 1.5-5 3-1.5-1.5-3-3-5-3-3 0-5 2.5-5 5.5 0 5 7 9.5 10 9.5s10-4.5 10-9.5c0-3-2-5.5-5-5.5z"/></svg>
      <span>Catppuccin</span>
    </div>
    <div class="theme-option" data-color-theme="paper">
      <svg class="theme-option-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
      <span>Paper</span>
    </div>
  </div>

  <!-- Theme dropdown (positioned at body level to avoid stacking context issues) -->
  <div id="theme-dropdown" class="theme-dropdown hidden">
    <div class="theme-option" data-theme="auto">
      <svg class="theme-option-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M12 2a10 10 0 0 1 0 20"/></svg>
      <span>Auto</span>
    </div>
    <div class="theme-option" data-theme="light">
      <svg class="theme-option-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      <span>Light</span>
    </div>
    <div class="theme-option" data-theme="dark">
      <svg class="theme-option-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      <span>Dark</span>
    </div>
  </div>

  <!-- More menu dropdown -->
  <div id="more-menu-dropdown" class="more-menu-dropdown hidden">
    <div class="more-menu-item mobile-only" id="more-stats">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="12" width="4" height="9"/><rect x="10" y="7" width="4" height="14"/><rect x="17" y="2" width="4" height="19"/></svg>
      <span>Stats</span>
    </div>
    <div class="more-menu-item mobile-only" id="more-files">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
      <span>Browse Files</span>
    </div>
    <div class="more-menu-item" id="more-memory">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2a4 4 0 0 1 4 4v4a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/>
        <path d="M8 14v2a4 4 0 0 0 8 0v-2"/>
        <circle cx="12" cy="20" r="2"/>
      </svg>
      <span>Memory</span>
    </div>
    <div class="more-menu-item mobile-only" id="more-archive">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="5" rx="1"/><path d="M4 9v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9"/><path d="M10 13h4"/></svg>
      <span id="more-archive-label">Show Archived</span>
    </div>
    <div class="more-menu-divider mobile-only"></div>
    <!-- Color Theme expandable section -->
    <div class="more-menu-item more-menu-expandable" id="more-color-theme">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="10.5" r="2.5"/><circle cx="8.5" cy="7.5" r="2.5"/><circle cx="6.5" cy="12.5" r="2.5"/><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12c0 1.82.486 3.53 1.337 5.003.577 1 .163 2.527-.663 3.497l-.09.1C4.033 21.616 7.838 22 12 22z"/></svg>
      <span>Color Theme</span>
      <svg class="expand-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
    <div class="more-menu-subitems" id="home-color-theme-items">
      <div class="more-menu-subitem" data-color-theme="darjeeling"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg><span>Darjeeling</span></div>
      <div class="more-menu-subitem" data-color-theme="budapest"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="10" width="18" height="11" rx="2"/><path d="M9 21v-6a3 3 0 0 1 6 0v6"/><path d="M3 10V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v4"/><path d="M12 2v2"/></svg><span>Budapest</span></div>
      <div class="more-menu-subitem" data-color-theme="moonrise"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 11l2-2 4 4 6-6 6 6"/><path d="M3 17l2-2 4 4 6-6 6 6"/></svg><span>Moonrise</span></div>
      <div class="more-menu-subitem" data-color-theme="aquatic"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12c2-3 5-5 10-5s8 2 10 5c-2 3-5 5-10 5s-8-2-10-5z"/><circle cx="12" cy="12" r="3"/></svg><span>Aquatic</span></div>
      <div class="more-menu-subitem" data-color-theme="fjord"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3l4 8 5-5 4 14H3L8 3z"/></svg><span>Fjord</span></div>
      <div class="more-menu-subitem" data-color-theme="monokai"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 8h4"/><path d="M7 12h8"/><path d="M7 16h6"/></svg><span>Monokai</span></div>
      <div class="more-menu-subitem" data-color-theme="catppuccin"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 8c-2 0-3.5 1.5-5 3-1.5-1.5-3-3-5-3-3 0-5 2.5-5 5.5 0 5 7 9.5 10 9.5s10-4.5 10-9.5c0-3-2-5.5-5-5.5z"/></svg><span>Catppuccin</span></div>
      <div class="more-menu-subitem" data-color-theme="paper"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg><span>Paper</span></div>
    </div>
    <!-- Light/Dark expandable section -->
    <div class="more-menu-item more-menu-expandable" id="more-theme-toggle">
      <svg id="more-theme-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      <span id="more-theme-label">Light/Dark</span>
      <svg class="expand-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
    <div class="more-menu-subitems" id="home-theme-items">
      <div class="more-menu-subitem" data-theme="auto"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M12 2a10 10 0 0 1 0 20"/></svg><span>Auto</span></div>
      <div class="more-menu-subitem" data-theme="light"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><span>Light</span></div>
      <div class="more-menu-subitem" data-theme="dark"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><span>Dark</span></div>
    </div>
    <div class="more-menu-item" id="more-notifications-toggle">
      <svg id="more-notifications-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      <span id="more-notifications-label">Notifications: On</span>
    </div>
    <div class="more-menu-divider hidden" id="pwa-install-divider"></div>
    <div class="more-menu-item hidden" id="pwa-install-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      <span>Install App</span>
    </div>
  </div>

  <!-- Conversation Stats Dropdown (global for mobile support) -->
  <div id="conv-stats-dropdown" class="conv-stats-dropdown hidden"></div>

  <!-- Chat More Menu -->
  <div id="chat-more-dropdown" class="more-menu-dropdown hidden">
    <div class="more-menu-item" id="chat-more-stats">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
      <span>Stats</span>
    </div>
    <div class="more-menu-item" id="chat-more-files">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
      <span>Files &amp; History</span>
    </div>
    <div class="more-menu-item" id="chat-more-branches">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="6" cy="6" r="3"/><circle cx="18" cy="18" r="3"/><circle cx="18" cy="6" r="3"/><path d="M6 9v6c0 3 3 3 6 3h3"/></svg>
      <span>Branches</span>
    </div>
    <div class="more-menu-item" id="chat-more-capabilities">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 17l6-6-6-6"/><path d="M12 19h8"/></svg>
      <span>Commands &amp; Skills</span>
    </div>
    <div class="more-menu-item" id="chat-more-memory">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
      <span id="chat-more-memory-label">Memory: On</span>
    </div>
    <div class="more-menu-item" id="chat-more-sandbox">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      <span id="chat-more-sandbox-label">Sandbox: On</span>
    </div>
    <div class="more-menu-divider"></div>
    <!-- Color Theme expandable section -->
    <div class="more-menu-item more-menu-expandable" id="chat-more-color-theme">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="10.5" r="2.5"/><circle cx="8.5" cy="7.5" r="2.5"/><circle cx="6.5" cy="12.5" r="2.5"/><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12c0 1.82.486 3.53 1.337 5.003.577 1 .163 2.527-.663 3.497l-.09.1C4.033 21.616 7.838 22 12 22z"/></svg>
      <span>Color Theme</span>
      <svg class="expand-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
    <div class="more-menu-subitems" id="chat-color-theme-items">
      <div class="more-menu-subitem" data-color-theme="darjeeling"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg><span>Darjeeling</span></div>
      <div class="more-menu-subitem" data-color-theme="budapest"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="10" width="18" height="11" rx="2"/><path d="M9 21v-6a3 3 0 0 1 6 0v6"/><path d="M3 10V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v4"/><path d="M12 2v2"/></svg><span>Budapest</span></div>
      <div class="more-menu-subitem" data-color-theme="moonrise"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 11l2-2 4 4 6-6 6 6"/><path d="M3 17l2-2 4 4 6-6 6 6"/></svg><span>Moonrise</span></div>
      <div class="more-menu-subitem" data-color-theme="aquatic"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12c2-3 5-5 10-5s8 2 10 5c-2 3-5 5-10 5s-8-2-10-5z"/><circle cx="12" cy="12" r="3"/></svg><span>Aquatic</span></div>
      <div class="more-menu-subitem" data-color-theme="fjord"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3l4 8 5-5 4 14H3L8 3z"/></svg><span>Fjord</span></div>
      <div class="more-menu-subitem" data-color-theme="monokai"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 8h4"/><path d="M7 12h8"/><path d="M7 16h6"/></svg><span>Monokai</span></div>
      <div class="more-menu-subitem" data-color-theme="catppuccin"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 8c-2 0-3.5 1.5-5 3-1.5-1.5-3-3-5-3-3 0-5 2.5-5 5.5 0 5 7 9.5 10 9.5s10-4.5 10-9.5c0-3-2-5.5-5-5.5z"/></svg><span>Catppuccin</span></div>
      <div class="more-menu-subitem" data-color-theme="paper"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg><span>Paper</span></div>
    </div>
    <!-- Light/Dark expandable section -->
    <div class="more-menu-item more-menu-expandable" id="chat-more-theme-toggle">
      <svg id="chat-more-theme-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      <span id="chat-more-theme-label">Light/Dark</span>
      <svg class="expand-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
    <div class="more-menu-subitems" id="chat-theme-items">
      <div class="more-menu-subitem" data-theme="auto"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M12 2a10 10 0 0 1 0 20"/></svg><span>Auto</span></div>
      <div class="more-menu-subitem" data-theme="light"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><span>Light</span></div>
      <div class="more-menu-subitem" data-theme="dark"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><span>Dark</span></div>
    </div>
    <div class="more-menu-divider"></div>
    <div class="more-menu-item" id="chat-more-new">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      <span>New Chat Here</span>
    </div>
    <div class="more-menu-item" id="chat-more-export">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      <span>Export</span>
    </div>
    <div class="more-menu-item danger" id="chat-more-delete">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
      <span>Delete</span>
    </div>
  </div>

  <!-- Image Lightbox -->
  <div id="lightbox" class="lightbox hidden">
    <button id="lightbox-close" class="lightbox-close" aria-label="Close">&times;</button>
    <img id="lightbox-img" class="lightbox-img" src="" alt="">
    <a id="lightbox-download" class="lightbox-download" download aria-label="Download">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    </a>
  </div>


  <!-- Capabilities Modal -->
  <div id="capabilities-modal" class="modal-overlay hidden">
    <div class="modal capabilities-modal">
      <div class="capabilities-header">
        <h2>Commands &amp; Skills</h2>
        <button id="capabilities-close" class="capabilities-close" aria-label="Close">&times;</button>
      </div>
      <input type="text" id="capabilities-search" class="capabilities-search" placeholder="Search commands..." autocomplete="off">
      <div id="capabilities-list" class="capabilities-list"></div>
      <div class="capabilities-hint">Tap a command to insert it into the message</div>
    </div>
  </div>

  <script src="/lib/highlight.min.js"></script>
  <script type="module" src="/js/app.js"></script>
</body>
</html>
